{% extends "base.html" %}

{% block content %}

<!-- Header Section -->
<div class="card-static mb-4 fade-in">
  <div class="row align-items-center">
    <div class="col-md-8">
      <p class="text-muted small mb-1">Bienvenue</p>
      <h2 class="fw-600 mb-0">{{ current_user.email.split('@')[0].title() }}</h2>
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0">
      {% if current_user.plan == 'free' %}
      <a href="{{ url_for('main.pricing') }}" class="btn-minimal btn-primary">
        <i class="bi bi-star"></i>
        Passer Premium
      </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Subscription Card -->
<div
  class="card-minimal mb-4 {% if current_user.plan == 'free' %}bg-noir{% elif current_user.plan == 'standard' %}bg-bleu{% else %}bg-success{% endif %} text-white fade-in"
  style="background: {% if current_user.plan == 'free' %}linear-gradient(135deg, #0A0A0A 0%, #1a1a1a 100%){% elif current_user.plan == 'standard' %}linear-gradient(135deg, #2563EB 0%, #1d4ed8 100%){% else %}linear-gradient(135deg, #10B981 0%, #059669 100%){% endif %} !important;">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div class="d-flex align-items-center gap-3">
      <div class="d-flex align-items-center justify-content-center"
        style="width: 48px; height: 48px; border-radius: 12px; background: rgba(255, 255, 255, 0.2);">
        <i
          class="bi bi-{% if current_user.plan == 'premium' %}infinity{% elif current_user.plan == 'standard' %}lightning-charge{% else %}gift{% endif %} fs-4"></i>
      </div>
      <div>
        <div class="text-white-50 small mb-1">Votre Plan</div>
        <h4 class="fw-600 mb-0">{{ current_user.plan_display_name }}</h4>
      </div>
    </div>
    <div class="text-end">
      <h3 class="fw-600 mb-0">{{ current_user.get_total_units() }} <span class="text-white-50 fs-6 fw-normal">/
          {{ 'Illimité' if current_user.plan == 'premium' else ('10' if current_user.plan == 'standard' else '2') }}
        </span></h3>
      <small class="text-white-50">Appartements</small>
    </div>
  </div>
</div>

<!-- Stats Cards Améliorées -->
<div class="row g-3 mb-4 fade-in-up" style="animation-delay: 0.1s;">

  <!-- Revenus Potentiels -->
  <div class="col-md-6">
    <div class="card-static p-3 h-100">
      <div class="d-flex align-items-center gap-3 mb-2">
        <div class="d-flex align-items-center justify-content-center"
          style="width: 40px; height: 40px; border-radius: 10px; background: rgba(16, 185, 129, 0.1);">
          <i class="bi bi-cash-stack text-success"></i>
        </div>
        <span class="text-muted small fw-600">REVENUS MENSUELS</span>
      </div>
      <h3 class="fw-bold mb-0">{{ "{:,.0f}".format(monthly_potential).replace(',', ' ') }} <span
          class="text-muted fs-6 fw-normal">FCFA</span></h3>
      <p class="text-muted small mb-0 mt-1">
        Basé sur {{ occupied_units }} appartement(s) occupé(s)
      </p>
    </div>
  </div>

  <!-- Taux d'Occupation -->
  <div class="col-md-6">
    <div class="card-static p-3 h-100">
      <div class="d-flex align-items-center gap-3 mb-2">
        <div class="d-flex align-items-center justify-content-center"
          style="width: 40px; height: 40px; border-radius: 10px; background: rgba(37, 99, 235, 0.1);">
          <i class="bi bi-pie-chart text-bleu"></i>
        </div>
        <span class="text-muted small fw-600">TAUX D'OCCUPATION</span>
      </div>

      <div class="d-flex align-items-end justify-content-between mb-2">
        <h3 class="fw-bold mb-0">{{ occupancy_rate }}%</h3>
        <span class="small text-muted">{{ occupied_units }} / {{ total_units }} apparts</span>
      </div>

      <!-- Barre de progression -->
      <div class="progress" style="height: 6px; border-radius: 3px;">
        <div
          class="progress-bar {% if occupancy_rate > 80 %}bg-success{% elif occupancy_rate > 50 %}bg-primary{% else %}bg-warning{% endif %}"
          role="progressbar" style="width: {{ occupancy_rate }}%"></div>
      </div>
    </div>
  </div>
</div>

<!-- Export Excel Button (Premium Only) -->
{% if current_user.has_feature('export_excel') %}
<div class="mb-4 fade-in-up" style="animation-delay: 0.2s;">
  <a href="{{ url_for('finances.export_excel') }}"
    class="btn-minimal btn-success d-inline-flex align-items-center gap-2" download hx-boost="false">
    <i class="bi bi-file-earmark-excel"></i>
    Exporter en Excel
    <span class="badge bg-success-subtle text-success border border-success ms-2">Premium</span>
  </a>
  <p class="text-muted small mt-2 mb-0">
    <i class="bi bi-info-circle me-1"></i>
    Exportez l'historique complet de vos paiements au format Excel
  </p>
</div>
{% endif %}

<!-- Stats Grid -->
<div class="row g-3 mb-4">
  <!-- Revenue Card -->
  <div class="col-md-6 col-xl-3">
    <div class="card-minimal-sm hover-lift h-100 fade-in">
      <div class="d-flex align-items-start justify-content-between mb-3">
        <div class="d-flex align-items-center justify-content-center"
          style="width: 40px; height: 40px; border-radius: 8px; background: rgba(37, 99, 235, 0.1);">
          <i class="bi bi-currency-dollar text-bleu fs-5"></i>
        </div>
        <span class="badge-primary small">Mensuel</span>
      </div>
      <div class="small text-muted mb-1">Revenus Potentiels</div>
      <h4 class="fw-600 text-noir mb-0">{{ "{:,.0f}".format(monthly_potential).replace(',', ' ') }} <span
          class="fs-6 fw-normal text-muted">CFA</span></h4>
    </div>
  </div>

  <!-- Occupancy Card -->
  <div class="col-md-6 col-xl-3">
    <div class="card-minimal-sm hover-lift h-100 fade-in">
      <div class="d-flex align-items-start justify-content-between mb-3">
        <div class="d-flex align-items-center justify-content-center"
          style="width: 40px; height: 40px; border-radius: 8px; background: rgba(37, 99, 235, 0.1);">
          <i class="bi bi-pie-chart text-bleu fs-5"></i>
        </div>
        <span class="badge-minimal small">{{ occupied_units }}/{{ total_units }}</span>
      </div>
      <div class="small text-muted mb-1">Taux d'Occupation</div>
      <h4 class="fw-600 text-noir mb-2">{{ occupancy_rate }}%</h4>
      <div class="progress" style="height: 4px; border-radius: 4px; background: var(--gris-100);">
        <div class="progress-bar" role="progressbar"
          style="width: {{ occupancy_rate }}%; background: var(--bleu); border-radius: 4px;"></div>
      </div>
    </div>
  </div>

  <!-- Properties Card -->
  <div class="col-md-6 col-xl-3">
    <div class="card-minimal-sm hover-lift h-100 fade-in">
      <div class="d-flex align-items-center justify-content-center mb-3"
        style="width: 40px; height: 40px; border-radius: 8px; background: rgba(37, 99, 235, 0.1);">
        <i class="bi bi-building text-bleu fs-5"></i>
      </div>
      <div class="small text-muted mb-1">Immeubles</div>
      <h4 class="fw-600 text-noir mb-0">{{ total_properties }}</h4>
    </div>
  </div>

  <!-- Vacant Card -->
  <div class="col-md-6 col-xl-3">
    <div class="card-minimal-sm hover-lift h-100 fade-in {% if vacant_units > 0 %}border-0{% endif %}"
      style="{% if vacant_units > 0 %}background: rgba(239, 68, 68, 0.05);{% endif %}">
      <div class="d-flex align-items-start justify-content-between mb-3">
        <div class="d-flex align-items-center justify-content-center"
          style="width: 40px; height: 40px; border-radius: 8px; background: {% if vacant_units > 0 %}rgba(239, 68, 68, 0.1){% else %}rgba(37, 99, 235, 0.1){% endif %};">
          <i class="bi bi-{% if vacant_units > 0 %}exclamation-triangle{% else %}check-circle{% endif %} 
                       {% if vacant_units > 0 %}text-danger{% else %}text-bleu{% endif %} fs-5"></i>
        </div>
        {% if vacant_units > 0 %}
        <span class="badge-danger small">Vacant</span>
        {% endif %}
      </div>
      <div class="small text-muted mb-1">Apparts Vides</div>
      <h4 class="fw-600 mb-0 {% if vacant_units > 0 %}text-danger{% else %}text-noir{% endif %}">{{ vacant_units }}</h4>
    </div>
  </div>
</div>

<!-- Premium Features Section -->
{% if current_user.plan in ['standard', 'premium'] %}

<!-- Quick Actions (Premium) -->
{% if current_user.has_feature('payment_reminders') %}
<div class="d-flex justify-content-end mb-4 fade-in-up">
  <a href="{{ url_for('finances.reminders') }}" class="btn btn-white border shadow-sm fw-600 text-danger hover-lift">
    <i class="bi bi-bell-fill me-2"></i>Gérer les retards
    <span class="badge bg-danger ms-2">Premium</span>
  </a>
</div>
{% endif %}

<!-- Advanced Stats (Standard & Premium only) -->
<div class="mb-4">
  <h6 class="fw-600 mb-3 text-uppercase small" style="letter-spacing: 0.5px; color: var(--gris-600);">
    Statistiques Avancées
    <span class="badge-primary small ms-2">
      <i class="bi bi-star-fill"></i> {{ 'Premium' if current_user.plan == 'premium' else 'Standard' }}
    </span>
  </h6>
  <div class="row g-3">
    <!-- Yearly Revenue Projection (Standard & Premium) -->
    <div class="col-md-4">
      <div class="card-minimal-sm h-100 fade-in">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-graph-up-arrow text-success"></i>
          <span class="small text-muted">Projection Annuelle</span>
        </div>
        <h5 class="fw-600 text-noir mb-0">{{ "{:,.0f}".format(monthly_potential * 12).replace(',', ' ') }} <span
            class="fs-6 fw-normal text-muted">CFA</span></h5>
      </div>
    </div>

    <!-- Average Rent (Standard & Premium) -->
    <div class="col-md-4">
      <div class="card-minimal-sm h-100 fade-in">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-calculator text-bleu"></i>
          <span class="small text-muted">Loyer Moyen</span>
        </div>
        <h5 class="fw-600 text-noir mb-0">
          {% if total_units > 0 %}
          {{ "{:,.0f}".format(monthly_potential / total_units).replace(',', ' ') }} <span
            class="fs-6 fw-normal text-muted">CFA</span>
          {% else %}
          0 <span class="fs-6 fw-normal text-muted">CFA</span>
          {% endif %}
        </h5>
      </div>
    </div>

    <!-- Performance Score (Premium only) -->
    {% if current_user.plan == 'premium' %}
    <div class="col-md-4">
      <div class="card-minimal-sm h-100 fade-in" style="background: rgba(16, 185, 129, 0.05);">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-trophy text-success"></i>
          <span class="small text-muted">Score Performance</span>
        </div>
        <h5 class="fw-600 text-success mb-0">
          {% if occupancy_rate >= 90 %}Excellent{% elif occupancy_rate >= 70 %}Bon{% elif occupancy_rate >= 50 %}Moyen{%
          else %}À améliorer{% endif %}
          <span class="fs-6 fw-normal text-muted">({{ occupancy_rate }}%)</span>
        </h5>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Premium Analytics Chart (Premium only) -->
{% if current_user.plan == 'premium' and premium_stats %}
<div class="mb-4">
  <div class="card-static fade-in">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h6 class="fw-600 mb-1">Évolution des Revenus</h6>
        <p class="text-muted small mb-0">Revenus mensuels des 12 derniers mois</p>
      </div>
      <span class="badge-primary small">
        <i class="bi bi-graph-up"></i> Premium Analytics
      </span>
    </div>
    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const canvas = document.getElementById('revenueChart');
    if (!canvas) return; // Sécurité si l'élément n'existe pas

    const monthlyData = {{ premium_stats.monthly_revenue | tojson
  }};
  const months = Object.keys(monthlyData);
  const revenues = Object.values(monthlyData);

  const ctx = canvas.getContext('2d');

  // Détruire l'ancien graphique s'il existe
  if (window.myRevenueChart instanceof Chart) {
    window.myRevenueChart.destroy();
  }

  window.myRevenueChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Revenus (FCFA)',
        data: revenues,
        borderColor: 'rgb(37, 99, 235)',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // Permet de s'adapter à la hauteur du conteneur
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              return 'Revenus: ' + context.parsed.y.toLocaleString('fr-FR') + ' FCFA';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function (value) {
              return value.toLocaleString('fr-FR') + ' F';
            }
          }
        }
      }
    }
  });
  }) ();
</script>
{% endif %}
{% else %}
<!-- Upgrade Prompt for Free Users -->
<div class="card-minimal mb-4 fade-in"
  style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%); border: 2px dashed var(--bleu);">
  <div class="text-center py-4">
    <i class="bi bi-lock fs-1 text-bleu mb-3 d-block"></i>
    <h5 class="fw-600 mb-2">Débloquez les Statistiques Avancées</h5>
    <p class="text-muted small mb-4">
      Projection annuelle, loyer moyen, score de performance et bien plus encore avec les plans Standard ou Illimité.
    </p>
    <a href="{{ url_for('main.pricing') }}" class="btn-minimal btn-primary">
      <i class="bi bi-unlock"></i> Voir les plans
    </a>
  </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="mb-4">
  <h6 class="fw-600 mb-3 text-uppercase small" style="letter-spacing: 0.5px; color: var(--gris-600);">Actions Rapides
  </h6>
  <div class="row g-3">
    <div class="col-md-6">
      <a href="{{ url_for('properties.add') }}" class="card-minimal-sm text-decoration-none hover-lift d-block">
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center justify-content-center"
            style="width: 40px; height: 40px; border-radius: 8px; background: var(--bleu); color: white;">
            <i class="bi bi-plus-lg"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="fw-600 text-noir mb-1 small">Ajouter un Immeuble</h6>
            <p class="text-muted mb-0" style="font-size: 0.8125rem;">Créez une nouvelle propriété</p>
          </div>
          <i class="bi bi-arrow-right text-muted"></i>
        </div>
      </a>
    </div>
    <div class="col-md-6">
      <a href="{{ url_for('properties.index') }}" class="card-minimal-sm text-decoration-none hover-lift d-block">
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center justify-content-center"
            style="width: 40px; height: 40px; border-radius: 8px; background: rgba(37, 99, 235, 0.1);">
            <i class="bi bi-list-ul text-bleu"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="fw-600 text-noir mb-1 small">Gérer mes biens</h6>
            <p class="text-muted mb-0" style="font-size: 0.8125rem;">Voir la liste complète</p>
          </div>
          <i class="bi bi-arrow-right text-muted"></i>
        </div>
      </a>
    </div>
  </div>
</div>

<!-- Mobile FAB -->
<div class="d-lg-none position-fixed" style="bottom: 90px; right: 20px; z-index: 900;">
  <a href="{{ url_for('properties.add') }}"
    class="btn-minimal btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center"
    style="width: 56px; height: 56px; padding: 0;">
    <i class="bi bi-plus-lg fs-4"></i>
  </a>
</div>

{% endblock %}